#!/bin/bash

set -o pipefail

function usage {

    echo ""
	echo "Runs dicom tarball(s) to BIDS conversion using heudiconv"
	echo "Usage $0  <optional flags>   <in tar file(s)>"
	echo ""
    echo " Assumes tar files are generated by cfmm2tar or dicom2tar (to find PatientName)"
    echo " If this is not the case, please use the -T option. "
    echo ""
	echo " Optional flags (must appear before required arguments):"
	echo "	-P <patient name search string> :  default:  $patientname_search "
	echo "	-T <tar name search string> :  uses tarfile name instead of PatientName to search, e.g. '{subject}' if <subject>.tar" 
	echo "	-o <output_dir> : default=$output_dir"
	echo "	-N <num parallel cores> : default=0  (max cores)"
	echo "	-h <heuristic.py> : default=$heuristic"
	echo "	-w <tempdir>  (--tempdir in heudiconv)"
	echo "	-b <bidsignore> : default=$execpath/etc/bidsignore"
	echo "	-O \"<additional heudiconv options>\" : default=$heudi_opts"
	echo "	-C : copy tarfiles to BIDS sourcedata folder" 
	echo "	-D : enable defacing of T1w images : default will not deface"
	echo "	-x : run dcm2niix without any heuristics, files placed in OUTPUT/sourcedata/dcm2niix/"
    echo "  -U <factor>: set uni-den mp2rage denoising multiplicative factor : default=$uniden_factor"
	echo ""
	echo " Available heuristic files:"
	for h in `ls ${heuristic_dir}/*.py`
	do
		echo "	${h##*/}"
	done
	exit 1
}

execpath=`dirname $0`
execpath=`realpath $execpath`

heuristic_dir=$execpath/heuristics
output_dir=./bids
heuristic=cfmm_base.py
heudi_opts=
patientname_search='*_{subject}'
tarfile_search=
ncores=0
tempdir=
copytar=0
do_deface=0
do_dcm2niix=0
uniden_factor=6


while getopts "N:o:h:O:P:T:w:b:CDxU:" options; do
 case $options in
    N ) echo "  Overriding number of cores: $OPTARG" >&2
	ncores=$OPTARG;;
    D ) echo "  Enabling deface of T1w images" >&2
	do_deface=1;;
    o ) echo "	Overriding output dir as: $OPTARG" >&2
	output_dir=`realpath $OPTARG`;;
    h ) echo "	Overriding heuristic file as: $OPTARG" >&2
	heuristic=$OPTARG;;
    O ) echo "	Using heudiconv options: $OPTARG"  >&2
	heudi_opts="$OPTARG";;
    P ) echo "  Using custom PatientName search: $OPTARG" >&2
	patientname_search="$OPTARG";;
    T ) echo "  Using custom tarfile name search: $OPTARG" >&2
	tarfile_search="$OPTARG";;
    w ) echo "  Using --tempdir=$OPTARG" >&2
    tempdir=$OPTARG;;
    b ) echo "  Using custom .bidsignore: $OPTARG" >&2
	bidsignore="$OPTARG";;
    C ) echo "  Copying source tarfiles to sourcedata" >&2
    copytar=1;;
    x ) echo "  Running dcm2niix with no heuristics" >&2
    do_dcm2niix=1;;
    U ) echo "  Using UNI-DEN factor: $OPTARG"  >&2
    uniden_factor=$OPTARG;;


   * ) usage
	exit 1;;
 esac
done

shift $((OPTIND-1))

if [ -e $heuristic ]
then
 heuristic_file=`realpath $heuristic`
else
 heuristic_file=$heuristic_dir/$heuristic
 if [ ! -e $heuristic_file ]
 then
   echo $heuristic does not exist!
   exit 1 
 fi
fi

if [ "$#" -lt 1 ]
then
  usage;
  exit 1;
fi


output_dir=`realpath $output_dir`
code_dir=$output_dir/code
sourcedata=$output_dir/sourcedata
mkdir -p $code_dir $sourcedata

datestring=`date +%Y-%m-%d_%Hh%Mm_$RANDOM`
log_dir=$code_dir/tar2bids_$datestring
if [ -e $log_dir ]
then 
 log_dir=${log_dir}_`date +%M`
fi

mkdir -p $log_dir

subjlist=$log_dir/subjects-list.txt
validator_out=$log_dir/bids-validator.txt
heudiconv_out=$log_dir/heudiconv
mkdir $log_dir/logs
heudi_log=$log_dir/logs/heudiconv
tuneup_log=$log_dir/logs/tuneup
heudiconv_subjlist=$log_dir/subj_args.txt
heudiconv_subjlist_all=$log_dir/subj_args.all.txt
heudiconv_sesslist=$log_dir/sess_args.txt
heudiconv_sesslist_all=$log_dir/sess_args.all.txt
dicomexpr_list=$log_dir/dicomexpr.txt

heudi_opts="$heudi_opts --overwrite"


# parse tarfile names to get subjids
for tar in $@
do

    if [ ! -e $tar ]
    then
        echo "  ERROR in $0: tar file $tar does not exist!"
        exit 1
    fi

    if [ "$copytar" = "1" ]
    then
        cp -v $tar $sourcedata
    fi

	filename=${tar##*/}

	folder=`realpath $(dirname $tar)`
	
	#do_dcm2niix 
	if [ "$do_dcm2niix" = 1 ] 
	then

		if [ -n "$tempdir" ]
		then
			dcm_dir=$tempdir/temp_dicoms_$RANDOM
		else
			dcm_dir=/tmp/temp_dicoms_$RANDOM
		fi

		nii_dir=$sourcedata/dcm2niix/${filename%.tar*}

		mkdir -p $dcm_dir $nii_dir
		#extract tar file 
		tar -C $dcm_dir -xvf $tar 
		dcm2niix -o $nii_dir -d 10 $dcm_dir
		rm -rf $dcm_dir
	fi



	#default, search for subjid in PatientName
	if [ ! -n "$tarfile_search" ]
	then

	pi=`echo $filename | awk  -F '_' '{print $1}'`
	pi_study=${filename%%_[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_*}
	study=${pi_study##${pi}_}
	date_etc=${filename##${pi}_${study}_}
	date=${date_etc%%_*}

	patient_etc=${date_etc##${date}_}
	#original
	#patient=${patient_etc%_[0-9]*.*}
	
	#########
	#yingli:
	#########
	#Why:
	#  original '#patient=${patient_etc%_[0-9]*.*}' was designed for parse `PatientName` from
	#    PI_project_studydate_PatientName_x.hashcode.tar (mostly CFMM 3T, 7T scan)
	#  as for
	#    PI_project_studydate_PatientName_StudyDate_xy.hashcode.tar
	#  It will parse `PatientName` to
	#    PatientName_StudyDate
	#
	#  for details/discussion:
	#    https://github.com/khanlab/tar2bids/issues/13
	#
	#New:
	#  Parse `PatientName` given both filename:
	#    PI_project_studydate_PatientName_x.hashcode.tar (mostly CFMM 3T, 7T scan)
	#    PI_project_studydate_PatientName_StudyDate_xy.hashcode.tar
	
	patient=''

	#PI_project_studydate_PatientName_x.hashcode.tar
	#  x is studyID, for instance 1
	if [[ $patient_etc == *_[0-9].*.* ]]; then
	    patient=${patient_etc%_[0-9].*.*}
	fi

	#PI_project_studydate_PatientName_StudyDate_xy.hashcode.tar
	#  StudyDate: for instance, 20190101
	#  xy is StudyID, for instance, 01
	if [[ $patient_etc == *_[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_[0-9][0-9].*.* ]]; then
	    patient=${patient_etc%_[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_[0-9][0-9].*.*}
	fi

	# if $patient is empty, skip it.
	if [ -z $patient ]; then
	    echo "Error: can not parse subject name in " $filename " skipped!"
	    continue
	fi

	suffix=${patient_etc##${patient}_}


	echo "  PI=$pi Study=$study Date=$date PatientName=$patient"
	search="${pi}_${study}_${date}_${patientname_search}_[0-9]*.*.t*"
	subjid=`$execpath/etc/getSubjSessID $patientname_search subject $patient`
	sessid=`$execpath/etc/getSubjSessID $patientname_search session $patient`
    
    #expression for heudiconv
#    dicom_expr=$folder/${pi}_${study}_????????_${patientname_search}_?.????????.t*
     dicom_expr=$folder/${pi}_${study}_${date}_${patientname_search}_${suffix}
    echo $dicom_expr >> $dicomexpr_list
	else
	#if -s specified, then search in tarfile
    search="${tarfile_search}.t*"
	subjid=`$execpath/etc/getSubjSessID $tarfile_search subject ${filename%.t*}`
	sessid=`$execpath/etc/getSubjSessID $tarfile_search session ${filename%.t*}`
    
    #expression for heudiconv
    dicom_expr=$folder/${tarfile_search}.t*
    echo $dicom_expr >> $dicomexpr_list

	fi
	
	if [ ! $? = 0 ]
	then
		echo    ERROR in $0: no matching subjid in tar: $tar
		echo $subjid
		exit 1
	fi

	if [ -n "$sessid" ]
	then
	echo "$filename -> sub-$subjid , ses-$sessid"
	else
	echo "$filename -> sub-$subjid"
	fi

	#compile subjid list
	if [ -n "$sessid" ]
	then
		echo "$subjid" >> $heudiconv_subjlist_all
		echo "$sessid" >> $heudiconv_sesslist_all
#	echo "-s $subjid -ss $sessid" >> $heudiconv_subjlist
	else
		echo "$subjid" >> $heudiconv_subjlist_all
	fi
	echo $subjid >> $subjlist


done

if [ ! -e $subjlist ]
then
 echo "no subjects found! exiting.."
 exit 1
fi

##sort and remove duplicate entries in subjlist
sort -u $heudiconv_subjlist_all -o $heudiconv_subjlist
if [ -e $heudiconv_sesslist_all ]
then
sort -u $heudiconv_sesslist_all -o $heudiconv_sesslist
fi
sort -u $subjlist -o $subjlist


#options for GNU parallel
popts="--no-notice --verbose --jobs $ncores -u"
popts_heudiconv="--no-notice --verbose --jobs 1 -u" #force only one heudiconv job at a time to avoid oversubscribing memory

if [ -n "$tempdir" ]
then
    export TMPDIR=$tempdir
fi

echo "  Running: heudiconv ... "


if [ -n "$sessid" ]
then


parallel --link -a $heudiconv_subjlist_all -a $heudiconv_sesslist_all -a $dicomexpr_list $popts_heudiconv  "heudiconv ${heudi_opts} -b -d {3} -o $output_dir -f $heuristic_file -s {1} -ss {2} | tee $heudi_log.{1}.{2} "

else

parallel --link -a $heudiconv_subjlist_all  -a $dicomexpr_list $popts_heudiconv  "heudiconv ${heudi_opts} -b -d {2} -o $output_dir -f $heuristic_file -s {1}  | tee $heudi_log.{1}"

fi



echo "  Moving hidden .heudiconv folder to $heudiconv_out"
mv $output_dir/.heudiconv $heudiconv_out


if [ -n "$sessid" ]
then
#check if certain files exist that need further corrections: (the following simply suppresses stderr: 1>/dev/null 2>&1)
Nfmaps=`ls $output_dir/sub-*/ses-*/fmap/*phasediff.nii.gz 2>/dev/null | wc -l`
NfmapsCase2=`ls $output_dir/sub-*/ses-*/fmap/*twomagphase1.nii.gz 2>/dev/null | wc -l`
Ngre=`ls $output_dir/sub-*/ses-*/anat/*GRE?.nii.gz 2>/dev/null | wc -l`
Nbold=`ls $output_dir/sub-*/ses-*/func/*bold?.nii.gz 2>/dev/null | wc -l`
Nmemp2rage=`ls $output_dir/sub-*/ses-*/anat/*MP2RAGE?.nii.gz 2>/dev/null | wc -l`
Nmemprage=`ls $output_dir/sub-*/ses-*/anat/*MEMPRAGE?.nii.gz 2>/dev/null | wc -l`
Nsa2rage_complex=`ls $output_dir/sub-*/ses-*/fmap/*SA2RAGE?.nii.gz 2>/dev/null | wc -l`
Nmp2rage=`ls $output_dir/sub-*/ses-*/anat/*MP2RAGE.nii.gz 2>/dev/null | wc -l`
Ndwi=`ls $output_dir/sub-*/ses-*/dwi/*dwi.nii.gz 2>/dev/null | wc -l`
Nbvec=`ls $output_dir/sub-*/ses-*/dwi/*dwi.bvec 2>/dev/null | wc -l`
else
#check if certain files exist that need further corrections: (the following simply suppresses stderr: 1>/dev/null 2>&1)
Nfmaps=`ls $output_dir/sub-*/fmap/*phasediff.nii.gz 2>/dev/null | wc -l`
NfmapsCase2=`ls $output_dir/sub-*/fmap/*twomagphase1.nii.gz 2>/dev/null | wc -l`
Ngre=`ls $output_dir/sub-*/anat/*GRE?.nii.gz 2>/dev/null | wc -l`
Nbold=`ls $output_dir/sub-*/func/*bold?.nii.gz 2>/dev/null | wc -l`
Nmemp2rage=`ls $output_dir/sub-*/anat/*MP2RAGE?.nii.gz 2>/dev/null | wc -l`
Nmemprage=`ls $output_dir/sub-*/anat/*MEMPRAGE?.nii.gz 2>/dev/null | wc -l`
Nsa2rage_complex=`ls $output_dir/sub-*/fmap/*SA2RAGE?.nii.gz 2>/dev/null | wc -l`
Nmp2rage=`ls $output_dir/sub-*/anat/*MP2RAGE.nii.gz 2>/dev/null | wc -l`
Ndwi=`ls $output_dir/sub-*/dwi/*dwi.nii.gz 2>/dev/null | wc -l`
Nbvec=`ls $output_dir/sub-*/dwi/*dwi.bvec 2>/dev/null | wc -l`
fi



if [ ! "$Nfmaps" = 0 ]
then
echo "  Running bids correction from phasediff fieldmap data..."

if [ -n "$sessid" ]
then
parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctFieldMap $output_dir {1} {2} | tee -a $tuneup_log.{1}.{2} " 
else
parallel -a $heudiconv_subjlist  $popts "$execpath/etc/correctFieldMap $output_dir {1} | tee -a $tuneup_log.{1}" 
fi

fi


if [ ! "$NfmapsCase2" = 0 ]
then
echo "  Running bids correction from phasediff fieldmap data..."

if [ -n "$sessid" ]
then
parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctFieldMapCase2 $output_dir {1} {2} | tee -a $tuneup_log.{1}.{2} " 
else
parallel -a $heudiconv_subjlist  $popts "$execpath/etc/correctFieldMapCase2 $output_dir {1} | tee -a $tuneup_log.{1}" 
fi

fi



if [ ! "$Ngre" = 0 -o ! "$Nmemp2rage" = 0 -o ! "$Nsa2rage_complex" = 0 -o ! "$Nmemprage" = 0 ]
then
echo "  Running bids correction from multi-echo GRE and MP2RAGE fieldmap data..."

if [ -n "$sessid" ]
then

parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctMultiEcho $output_dir {1} {2} | tee -a $tuneup_log.{1}.{2}"
else
parallel -a $heudiconv_subjlist $popts "$execpath/etc/correctMultiEcho $output_dir {1} | tee -a $tuneup_log.{1}"
fi

fi

if [ ! "$Nbold" = 0 ]
then
echo "  Running bids correction from multi-echo EPI data..."

if [ -n "$sessid" ]
then

parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctMultiEchoEPI $output_dir {1} {2} | tee -a $tuneup_log.{1}.{2}"
else
parallel -a $heudiconv_subjlist $popts "$execpath/etc/correctMultiEchoEPI $output_dir {1} | tee -a $tuneup_log.{1}"
fi

fi

if [ ! "$Nmprage" = 0 ]
then

echo " Running script to compute UNI-DEN from UNI & inversions (if it doesn't exist already)"
if [ -n "$sessid" ]
then
parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctUniDen $output_dir $uniden_factor {1} {2} | tee -a $tuneup_log.{1}.{2}"
else
parallel -a $heudiconv_subjlist $popts "$execpath/etc/correctUniDen $output_dir $uniden_factor {1} | tee -a $tuneup_log.{1}"
fi

fi

#if number of dwi != number of bvec files, then we are most likely dealing with bruker dwi, use custom script to extract bvec
if [ ! "$Ndwi" = "$Nbvec" ]
then

echo " Running bvac/bval/bmat generation for Bruker data"
if [ -n "$sessid" ]
then
parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/correctBrukerBdata $output_dir $tar {1} {2} | tee -a $tuneup_log.{1}.{2}"
else
parallel -a $heudiconv_subjlist $popts "$execpath/etc/correctBrukerBdata $output_dir $tar {1} | tee -a $tuneup_log.{1}"
fi
fi

#merge any vNav files if they exist
python3 $execpath/etc/merge_vNav.py $output_dir

#average m3mprage images
python3 $execpath/etc/memp2rage_bids_corrector.py $output_dir/*/anat

#remove scans.tsv files as they may be out of date after corrections
rm -f $output_dir/*/*_scans.tsv $output_dir/*/*/*_scans.tsv

#remove .bval and .bvec files from fmap
rm -f $output_dir/*/fmap/*.bval $output_dir/*/*/fmap/*.bval
rm -f $output_dir/*/fmap/*.bvec $output_dir/*/*/fmap/*.bvec


if [ "$do_deface" = "1" ]
then

echo "  Defacing T1w images with pydeface... (if successful, will back-up non-defaced to sourcedata)"
if [ -n "$sessid" ]
then
parallel -a $heudiconv_subjlist -a $heudiconv_sesslist $popts "$execpath/etc/defaceImages $output_dir {1} {2} | tee -a $tuneup_log.{1}.{2}"
else
parallel -a $heudiconv_subjlist $popts "$execpath/etc/defaceImages $output_dir {1} | tee -a $tuneup_log.{1}"
fi

fi

echo "  Cleaning participants and other tsv files (sorting, removing extra columns)..."
$execpath/etc/cleanParticipantsFile $output_dir


#remove CogAtlasID from top-level bold json by grepping it out:
for json in `ls $output_dir/*bold.json 2> /dev/null`
do
    echo "Removing CogAtlasID from $json if it exists"
    grep -v CogAtlasID $json > $json.new && mv -v $json.new $json
done

if  [[ -n "$bidsignore" ]]; then
  echo "  Adding custom .bidsignore file..."
  cp -v "$bidsignore" "$output_dir/.bidsignore"
else
  echo "  Adding default .bidsignore file..."
  cp -v $execpath/etc/bidsignore $output_dir/.bidsignore
fi

echo "  Removing _ROI#.nii.gz files (unused scale bars from qMRI)..."
rm -vf $output_dir/sub*/*/*ROI[0-9].nii.gz $output_dir/sub*/ses*/*ROI[0-9].nii.gz 2> /dev/null

echo "  Running bids-validator..."
bids-validator $output_dir | tee  $validator_out

#exit with return val of bids validator
exit $?
